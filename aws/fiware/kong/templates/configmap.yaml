apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.kong.dblessConfig.configMap }}
data:
  kong.yml: |
    _format_version: "2.1"
    _transform: true

    services:
      # orion rate-limited
      - host: "fiware-orion-ld"
        name: "orion-limited"
        port: 1026
        protocol: http

        routes:
          - name: orion-limited
            paths:
              - /limited
            strip_path: true

        plugins:
          - name: rate-limiting
            config: 
              minute: 3

      # keyrock example
      - host: "fiware-orion-ld"
        name: "orion-keyrock"
        port: 1026
        protocol: http

        routes:
          - name: orion-keyrock
            paths:
              - /keyrock
            strip_path: true

        plugins:
          - name: prometheus
            config:
              per_consumer: true

          - name: rate-limiting
            config: 
              minute: 30

          - name: pep-plugin
            config:
              authorizationendpointtype: Keyrock
              authorizationendpointaddress: https://keyrock.fiware.dev/user
              keyrockappid: 0c47148c-50e7-4866-ac0d-941ef638efd7

          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization

      # i4Trust example
      - host: "fiware-orion-ld"
        name: "orion-i4trust"
        port: 1026
        protocol: http

        routes:
          - name: orion-i4trust
            paths:
              - /i4trust
            strip_path: true

        plugins:
          - name: prometheus

          - name: rate-limiting
            config: 
              minute: 30

          - name: ngsi-ishare-policies
            config:
              access_token:
                header_names:
                  - "authorization"
                  - "Authorization"
              ar:
                identifier: "EU.EORI.NL000000004"
                host: "https://ar.isharetest.net"
                token_endpoint: "https://ar.isharetest.net/connect/token"
                delegation_endpoint: "https://ar.isharetest.net/delegation"
              satellite:
                identifier: "EU.EORI.NL000000000"
                host: "https://scheme.isharetest.net"
                token_endpoint: "https://scheme.isharetest.net/connect/token"
                trusted_list_endpoint: "https://scheme.isharetest.net/trusted_list"
              jws:
                identifier: "EU.EORI.NLPACKETDEL"
                private_key: |
                  -----BEGIN RSA PRIVATE KEY-----
                  MIIEowIBAAKCAQEAvmI3YYrE/7KPLloQ15sH3bW91YZzgSbwIZ7aFXAb8c2T3TAA
                  McFBqS8VWxe9a6aFhXxNkwhUZQl6j1iZWICtIEmUbUrwU3aEmls4VObTcmPus8Tx
                  8RoBsXdmdSJx+3rEo9WXRM85UEOe5sJAWvVyDjznNrpfwkMdpR83x7dTjVPKXHqa
                  SaF1Hcriu272RY2GIS8IsciX2fOkBvFgxke332WnErRMU0LhcNbOl/4YYz993Awl
                  TIyHrqMGjjzmtvG4XWU7/7dSSIwMZqyaaX8ECQ9OOF9TQqtbpYGJnccfIL0KOtSY
                  qJXbo0T28BpwfqTNFPFpIXNxrU22x8m3QxMnUQIDAQABAoIBACJTQvjrNCmF4BrT
                  UkYNRZXLtrZQz3JxusnVAizrUZ5/GjG+/cn6tgPy4T7TQOuv0lMG3lWsIss0skw2
                  BS/Xw18W5RPvdvUVYUMTP0zPcUAmlFsFHzoBHl0I0gg8daCJufpwAB3/3q2CA5xH
                  WaMMrcuzX1yWrb0wrJ+gyUXQ39eS/AvZsKjMgznN44hXly8B6EAy28Miq8YR7vZN
                  A4ltNl6ecsq8rauVy958+ScXkZns5e8gctGhDpjafpKcYv8J3dcVx7e0PID/Ml3x
                  oEDEpad+dBed64xKs79I3/RIoa+ObNL44HhVhYfARLxr0MBE0Q4GBGuRB8C1meRY
                  p06FVCECgYEA7gjw6Ifnd2+mafbFYQPrIsMgvrmWfWbz+5tZq5ZqC47sFxluWWGd
                  TSp+8L8vkIZPIZ+/tU5JVIGzdEZQCbWF48MKnAkEH9T211M3Obz4lbqz/9zoNDIy
                  omY1zahruP4fn3ujJjS0CUbIcfmM2KE+xNy+Fgn19TbTGC4GQpyKsusCgYEAzMCb
                  n1SX7qMy6lV+b4CHBNwrJfYmV0UeDc9XXVhoVkMypGZ6oXnN+b//pv0EEqnXOzd7
                  BQHRfoe77uYbMVccg/yM6jNzfvKMpD0kpcdIwvjRm+ADysfi+HezDU8gVuDsL0Qu
                  xcugsrO3WjlFYNUhtrIRTNFZXOFN2HLiOm5y57MCgYBBxP6rgUGXYqYciS6oS6jg
                  hgG6MRU/uP6Y+qegHYNXhjn9d+1hjPMlqyQ/6NN/n1yl8bnKosLoMp4e9n6O8DT6
                  ZZ2811DoarN5c2jC70/QLzIk9CjEo0oSTSN4m5yIFM8wBb1ihRVpqsEfnNAp2wO4
                  6TUsabwn8OoKuEzKgu5f2QKBgQCiU0zNW258RawW9aKgWYAxjS80EFrDM0upXSkB
                  GxbU1L9wcMJmBEAU8W+H/u1csoOtMcX46UEiFBAdTRZf3pT/2pgJELNPAJIZn1PP
                  jheUY1kiP84h1KiPna45LfMQjY8Rxfdi3pXPNwV0pRTouO/afH+UrCAxr3lc0W+j
                  LW8xWwKBgHuaqGDBotq96aZ4V4e1RS0yCEPiw3EvuQJ76J+1MnCFZM9+EjxPQSHP
                  a3Y8CvPDSSHA6v+V7wRTMmKsCJEgTj43k+wdfy/GAz96iFrz1fEwN+Za8QbQ28es
                  462ne7r9npTrUcbOw4J89QuzWDX8XlhWVNxYhRY0sbkzk4USjy9x
                  -----END RSA PRIVATE KEY-----

                x5c: |
                  -----BEGIN CERTIFICATE-----
                  MIIEojCCAoqgAwIBAgIIR/ZYOdN7U74wDQYJKoZIhvcNAQELBQAwSDEZMBcGA1UE
                  AwwQaVNIQVJFVGVzdENBX1RMUzENMAsGA1UECwwEVGVzdDEPMA0GA1UECgwGaVNI
                  QVJFMQswCQYDVQQGEwJOTDAeFw0yMTAyMTgxMTI0MzBaFw0yMzAyMTgxMTI0MzBa
                  MGMxGTAXBgNVBAMMEFBhY2tldERlbGl2ZXJ5Q28xHDAaBgNVBAUTE0VVLkVPUkku
                  TkxQQUNLRVRERUwxGzAZBgNVBAoMElBhY2tldCBEZWxpdmVyeSBDbzELMAkGA1UE
                  BhMCTkwwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC+YjdhisT/so8u
                  WhDXmwfdtb3VhnOBJvAhntoVcBvxzZPdMAAxwUGpLxVbF71rpoWFfE2TCFRlCXqP
                  WJlYgK0gSZRtSvBTdoSaWzhU5tNyY+6zxPHxGgGxd2Z1InH7esSj1ZdEzzlQQ57m
                  wkBa9XIOPOc2ul/CQx2lHzfHt1ONU8pceppJoXUdyuK7bvZFjYYhLwixyJfZ86QG
                  8WDGR7ffZacStExTQuFw1s6X/hhjP33cDCVMjIeuowaOPOa28bhdZTv/t1JIjAxm
                  rJppfwQJD044X1NCq1ulgYmdxx8gvQo61JioldujRPbwGnB+pM0U8Wkhc3GtTbbH
                  ybdDEydRAgMBAAGjdTBzMAwGA1UdEwEB/wQCMAAwHwYDVR0jBBgwFoAUFjznIOnW
                  lO8f5aLxuPy+6t8sN4EwEwYDVR0lBAwwCgYIKwYBBQUHAwEwHQYDVR0OBBYEFIFS
                  4PXveJ4QmFV5FOw99PtG6q3vMA4GA1UdDwEB/wQEAwIFoDANBgkqhkiG9w0BAQsF
                  AAOCAgEATpijbDaS4JgI9zqcxFTKmlzEf6BtrwbMA4gl7TMuga+40wyU4HGkVwV8
                  Ssia90ZlH81ilY2qTbfQvLHIIiOidaHQA6DNEhmo0kEPPYJ/0EiTI7tCr5+DF59J
                  aYzX3U37R+dps8EeOhCMfEM9vkb4qnSFs3WlGKsTOvGsN6hgA0srlt7oJclC8zFO
                  U/sXa7DWtMTUt83zO4chXicqG8jv4uRYlqa2IcHCoIITL8Xif/aIf5P8QfQXFdms
                  SuPkEFAWj/E8LrO2QjEoHU6iD5OnocdsBwrtEwsmfSckBLOmdxj/3u2b7oa9nOZ/
                  q26V24vbkkLBN3og3QEaMR2NI+ZhcZ56oYymN7B8ArNTWI4NbnRO5M0VskznVSbp
                  1monmGqBavQH7bRlwXAn17YOIkvA5xxX6WrAiScyG5LxQ12TjYdN7jteebJKLKWF
                  c62veFYKJ/Nj2tuSC+yFGrfI6Sl9fj6tbIDqFEIgti8wgmCOKyZOts+RPa0SF7e0
                  W3RhmZt+rvd1p8CGZQwBIYe3aqV+0tUgSqLH54A89EEbU+M7SBvs8XS93seeJZGz
                  lu8y1ULzd/ddSzhMFm7VBNWtK0xk6WCtvK/Wh15A/NI6Dlg40SI55SQapH+0ezHl
                  q2M4MlD8uPy6TqSkL5U6mgOISwmQnZiDE0yazIeiKWS6VekqGLw=
                  -----END CERTIFICATE-----
                  -----BEGIN CERTIFICATE-----
                  MIIFcTCCA1mgAwIBAgIISFRJwGAAyjUwDQYJKoZIhvcNAQELBQAwRDEVMBMGA1UE
                  AwwMaVNIQVJFVGVzdENBMQ0wCwYDVQQLDARUZXN0MQ8wDQYDVQQKDAZpU0hBUkUx
                  CzAJBgNVBAYTAk5MMB4XDTE4MDcyMzE1MTQxM1oXDTIzMDcyMjE1MTQxM1owSDEZ
                  MBcGA1UEAwwQaVNIQVJFVGVzdENBX1RMUzENMAsGA1UECwwEVGVzdDEPMA0GA1UE
                  CgwGaVNIQVJFMQswCQYDVQQGEwJOTDCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCC
                  AgoCggIBAPueRXUGSUgu7qpAWJjAVH9z319XnuFleVeO/XxbJ6U4ixXRKvW8vKTV
                  1dRcfQeCqXk7ua/ZsqNrq89Ex95b0nqGUv1NoK2T8yEAkQzyzYZpW4c2YMCcg5am
                  RwCfYahHtJmXJWqREevM5kJoOacKH/GUbsemT94B0KXSNQ6IWcJyjpuaoDpb6Wd9
                  7T2luP1IQ5gkfwU38CZJKVkbY3eJkLlOwwtFsFPP2M4f8u479OkMUr5/m+xn73Ja
                  ZSJFOHvIN6DFpAls2ax7BhUSlbKM3YEuNb0O4oO5ynDFHvmllp6Nu0F2Xo0Bu0P/
                  uqb/08XvVWne7wcwWZR9+d78q+OlfC/m+wAwAqmQHEr8hJNvR6S/84HAjUdMyGcY
                  Tvov0tb0Zw/AKwDg8PC9UFRYb0cBr0+/GfgmJP5QMAfLqkXmZwYQSZ1FamNlJlmx
                  0sYZQSaudG0+Xkc991+Zw/x8uWZi9qQZeBOdwnI2xf/HJXHJsaZfDvTp5i8iVP75
                  1rhinwLi2dZnmSsQ96gvtTQBo4J5AvF+s9Il+TukeLtlKABaoMwz8wYBCnfKvUtk
                  p7JU5ijjYFaqQsFR3RpOHXcH/spZTYHuSs1OpHVbr0/cFtWZpv4tSQklPqCjddSA
                  SH9k3OBAhxenyXLkn9U9AAI34pZbFV+mksGGrN7ukk4obStI7z/5AgMBAAGjYzBh
                  MA8GA1UdEwEB/wQFMAMBAf8wHwYDVR0jBBgwFoAUra3KsTnUVnY8KXgl0RiiQBto
                  KEwwHQYDVR0OBBYEFBY85yDp1pTvH+Wi8bj8vurfLDeBMA4GA1UdDwEB/wQEAwIB
                  hjANBgkqhkiG9w0BAQsFAAOCAgEAeIJw1nnoOrsamueW4cZPLzrnuHSEvv1SEL1b
                  fB6F73anmxbq9+OYW6qojhxvorHTFzoQynsPmbso7t4b3HAtWaOlp3DKZUTpzOlL
                  nQ9gsDDfDVSJsJ5jxglDFZm0A07Ld3CxZhnzWf9A0QgNqN5hCcOsrl4uDMvZz+M9
                  kL/iksCx4X0so2OSm1QakraAR3umPc2ooAacPsAVCllekXFJ9DFjJ5Uv+rg8ZKHH
                  LGrP19o/AsXJYpKP/ttk5tBuA4JB20aShbcC539rA+Qc+kDHyRnL0aJyRYeBgY1i
                  AtuzXzMOk53XV+aJogDp3gF73s1c1YyIRHt7ofQG/0Zlwc/41CxOD+lyzG34RkgI
                  UO6UfjiGCFPmZQ2HkpKyqLifraRdqrHXOhoVd7HidYIihnZKDkLi1cfeo2mz8tWi
                  UzA+dPchaIElpQJPTjSbLjF2I19QyB8fuPazPfNIjHrXaKlaS3luKcFiqOYgcwWf
                  dZmDzxIU6PY2bzx/SDMoU24rAVSuGAYBIAlwf2pxmtLcbMA6bYr4trmQfbJrM8f8
                  JZgGQoItrpzrKjBJ2gFRt+065NMTNkB5rw8Xr56j5djkqB0/qHIcF2TiY/k/81Rm
                  TCYxrVHzM1czhXHXYzvnd2Jl1wJXyacWl7FiPaggw0YQidWHGMdItEuD/8SXiCXl
                  1OIvvic=
                  -----END CERTIFICATE-----
                  -----BEGIN CERTIFICATE-----
                  MIIFbTCCA1WgAwIBAgIIHjjfTuSjFjMwDQYJKoZIhvcNAQELBQAwRDEVMBMGA1UE
                  AwwMaVNIQVJFVGVzdENBMQ0wCwYDVQQLDARUZXN0MQ8wDQYDVQQKDAZpU0hBUkUx
                  CzAJBgNVBAYTAk5MMB4XDTE4MDcyMzE1MDUxM1oXDTI4MDcyMDE1MDUxM1owRDEV
                  MBMGA1UEAwwMaVNIQVJFVGVzdENBMQ0wCwYDVQQLDARUZXN0MQ8wDQYDVQQKDAZp
                  U0hBUkUxCzAJBgNVBAYTAk5MMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKC
                  AgEA4HIQ2eGXSP0bqgOs6IbrxTw/0u6XyRi5H/Z+j8hPzFeS/n7UcDs+48GYSgEN
                  1cIDBAGWjnwNM6u4RpQiG8xl7YtjWymwKm4HXtLAQqt72arY37PSF30Xi6VPBant
                  PTdaa+9zCU8CyFnEZ2fKTk1Sug36g6F6OjdgCCGkjdppKVyNIl5OW+kjFq2A9Gvt
                  BRGEwR2etotKtsIHI/g4cXOFZjtCCtPoEmjQ66fSwa7AjolpBb2PcssCVpb5c6sA
                  fp20JNn84kDQEoHjeoyNAqctBEIsRZF4kpTn4YhSXq0TH/kRtEEfNEmzLEOSaDWP
                  yL8qJJpx1aPAye0fkGfJi51cGRrFxf7jfN99Tjdf3yxwtT/yQquWLp6VLdqjJLk9
                  btGk+BiS9iVtw41Ec2ysX/3g0xeVVFGtyCwACWpyIx+Qm80KjVXkYDxhGiLQjQIz
                  VolPEVUDAZnw+LCmg3OY9Iy0PXTV0x3CKHM+C3ukZWkS1d3CSgDVl1+cpHJT4m6f
                  KnncO77yVO0yrW5218UGaYALOh8PHow36e9cB2c0bT2d1CHRekSl4+Bx+xQMGwsP
                  yveGgpkHidZtYRDP4E/HxNKy+wfByQeSu4YcUc8EHxy9qzxae28QfZn7s47V/PjA
                  k0dLZyQDonE9Q10OkMV15Dp9PWGeCQJri5JdOnr+iD8DdHsCAwEAAaNjMGEwDwYD
                  VR0TAQH/BAUwAwEB/zAfBgNVHSMEGDAWgBStrcqxOdRWdjwpeCXRGKJAG2goTDAd
                  BgNVHQ4EFgQUra3KsTnUVnY8KXgl0RiiQBtoKEwwDgYDVR0PAQH/BAQDAgGGMA0G
                  CSqGSIb3DQEBCwUAA4ICAQBCGYNl/1HFWVhDoPmkpVqm30ryqf6dWx1rxTW1lk9a
                  VUOlR9IRHPp1z/F/4fb6mIXFjFYw5lU2faHV9op4rNuGqRRSLiQPVvOXxDlxqA6D
                  mqziREvttG0uLZ/FOycKY53pWFCzG2keq6OId9JSpFmQDOiF7WSuifPLuwADkUw+
                  oZYGgWmbwQO0lXtw7XOny37nLZkYl89bRhIg/7fb+Xnb8914SMv0kGlk1kCeyL6F
                  XdXRTaat5c9XlJr9yzOUIDn54bY1BKT6YtiyJfvCNav/Fb24v5eq2Z9mBdZ70Cc9
                  5gPjqqxMZUgJo57YvhLfXDwxbWZWYC+WcR8nHkY+tZBlIih2CXHsOar5oH6drMdt
                  MIZz3UZJ/CxFG1u23Uz1jBfm/EggdKhOVnT6edruVoteWWCDB9Hdhxz8RAVYn5dq
                  UjkjRq4W9QAfJusrPZGBndT7yNaY/FHYKIq+uTarWibjdxtdYClaTwOxk5IqKNF9
                  eCKbPmxs1mlZrSLjMQFY3U9RkvzI+3IlAFkctUeabpkmXxnuWWSV2FJO9ZrONMWu
                  tw+567PK5gzM0FqQvb7sCxZuQDl5Ct6ZWlts2Y72t6pPjRI17+S8++a2vQdxBcNQ
                  0xF2tjvzTviZ3C5EqIeazWdgIZkqfWZkS8v+0MAvNZY+bbx+vSwLOoHQWrf/OCL7
                  AQ==
                  -----END CERTIFICATE-----
                  
          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization

      # keycloak example
      - host: "fiware-orion-ld"
        name: "orion-keycloak"
        port: 1026
        protocol: http

        routes:
          - name: orion-keycloak
            paths:
              - /keycloak
            strip_path: true

        plugins:
          - name: prometheus

          - name: rate-limiting
            config: 
              minute: 30

          - name: pep-plugin
            config:
              authorizationendpointtype: Keycloak
              authorizationendpointaddress: http://fiware-keycloak:80
              keycloakrealm: fiware-server
              keycloakclientid: orion-pep
              keycloakclientsecret: 978ad148-d99b-406d-83fc-578597290a79

          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization

      - host: "fiware-orion-ld"
        name: "orion-vc"
        port: 1026
        protocol: http
    
        routes:
          - name: orion-vc
            paths:
              - /orion-vc
            strip_path: true
    
        plugins:
          - name: pep-plugin
            config:
              pathprefix: "/orion-vc"
              authorizationendpointtype: ExtAuthz
              authorizationendpointaddress: http://fiware-pdp-dsba-pdp:8080/authz
                
          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization


      - host: "fiware-pdp-dsba-pdp"    
        name: "trusted-list"
        port: 8080
        protocol: http

        routes: 
          - name: trusted-list
            paths: 
              - /pdp     
            strip_path: true
