apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.kong.dblessConfig.configMap }}
data:
  kong.yml: |
    _format_version: "2.1"
    _transform: true

    services:
      # orion rate-limited
      - host: "fiware-orion-ld"
        name: "orion-limited"
        port: 1026
        protocol: http

        routes:
          - name: orion-limited
            paths:
              - /limited
            strip_path: true

        plugins:
          - name: rate-limiting
            config: 
              minute: 3

      # keyrock example
      - host: "fiware-orion-ld"
        name: "orion-keyrock"
        port: 1026
        protocol: http

        routes:
          - name: orion-keyrock
            paths:
              - /keyrock
            strip_path: true

        plugins:
          - name: prometheus
            config:
              per_consumer: true

          - name: rate-limiting
            config: 
              minute: 30

          - name: pep-plugin
            config:
              authorizationendpointtype: Keyrock
              authorizationendpointaddress: https://keyrock.fiware.dev/user
              keyrockappid: 7c902139-d4d0-461a-bb14-7fa29aa143fe

          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization

      # i4Trust example
      - host: "fiware-orion-ld"
        name: "orion-i4trust"
        port: 1026
        protocol: http

        routes:
          - name: orion-i4trust
            paths:
              - /i4trust
            strip_path: true

        plugins:
          - name: prometheus

          - name: rate-limiting
            config: 
              minute: 30

          - name: ngsi-ishare-policies
            config:
              access_token:
                header_names:
                  - "authorization"
                  - "Authorization"
              ar:
                identifier: "EU.EORI.NL000000004"
                host: "https://ar.isharetest.net"
                token_endpoint: "https://ar.isharetest.net/connect/token"
                delegation_endpoint: "https://ar.isharetest.net/delegation"
              satellite:
                identifier: "EU.EORI.NL000000000"
                host: "https://scheme.isharetest.net"
                token_endpoint: "https://scheme.isharetest.net/connect/token"
                trusted_list_endpoint: "https://scheme.isharetest.net/trusted_list"
              jws:
                identifier: "EU.EORI.Logislinktest"
                private_key: |
                  -----BEGIN PRIVATE KEY-----
                  MIIEowIBAAKCAQEAriUAtUb3tTd9Xv3S3lxpslm/FGsaMM4pO18umOOcilzKBafB
                  MBK1PawHcjd79TttZS0e9i+7v7+Gd5xPfMElvICt/o+DpoFZ4Zm+KolrWVhRZgfu
                  p8ZNjmWjsipxyu1cb0yJ8TDDHUKQrdB9hJPZ8IE9Y3FwGMT7kZz/dGNhX+zp2TLy
                  1TKXQZnB/QWfvqQwiyNL0cYn7Xj209i7wVDlnaBP53YisoSMD/cL6EyMKp3tBSti
                  yNr+TS5UFeRMsUtvxCuv49JGw5FNWexSIpRpYJFJ0/kKAv1zO8cD/vOxscTj3KcP
                  rsOk4uxNuPz5GCnuKxRZtVDULya454pn32bubwIDAQABAoIBABcthZ1FsiJvHZik
                  X98zSD4crnn2kf3SSAVG8y9rhqJDx1UJXC/HIv2aWpixGdEsn7AfrpybAyTPm64V
                  IonlizLo+D+GtRcBkFzz1tkCgUSFpLqCbm6WI4HDCrk5PPwCq5LaCmINA2sZjk1p
                  ZSCy17GoV0CtEHu7fArdbS1TLNqqDXa0N7yU6uqM4RJxwS9x0CBz0HPGKB7WSS73
                  RaH7NhPKXvQ3AiPGQNeFdDMWfqqUmaZx/YUnHSEJM769WyImFk+NKG3TCV93x6xG
                  kIhNvGky6v+58FEvItwNsWLMt0F4WsIurD6Q+dess4/3lb3tstKZEfCz2xz0C/wy
                  TxP/lIECgYEA03nbksU0w+KcPK/TzYA9gYylJWm9r5gsOayMrw16hG/K0MZGaL1/
                  yGP+ox6fo0RSJ/rB83fTq4UAb1FcKAuNNjQCwtQ0WvTLLWIG3J6tq2HpNb4u/7Ou
                  lPc9tId+PMQVmUPDGFoPlLw5N7XxAAl9rxhWtFmX41Xv881qrYTAU/kCgYEA0s8N
                  Yjr6ZZU7okdl/qmIvaQjpp03ADVqPl51oQ2owBBQwmZGUIhglqhDgulzGYxGeun7
                  b7uk4Q+GvSsGU8bQDjI4WDHLanFfJ8EBzkyerftjoZYTIxsfUmU7+6HG3mcVORHs
                  Es3bzxhXgDwqP/VzA4GGpmbmiOQJ+cQpkkEtH6cCgYB1EnvtB8GLQ9OMgSY3GOxz
                  4KG4UY6SPCMXlp+XdVXDJYRZCbsG1wl7rWfVc+maYAM/YMGogEitJoc0GQ10mdiG
                  DksNAp8tT2F/cUotLqckPqL1fqDUK+vVSf5eB7hp+X+fhnTl8U244G6omc+eXqK2
                  oTm2w/ajAvtAtBJ/lwNGOQKBgHlOTBVKeuwZg8dN7pMsW1NFMH6f2RZ1pj1dfbK/
                  eWuL9+zljXCqCWqoSLD8RQ9eePAh1F3nTGl11cLlDy8GKJMCswmNHdCSjH8DwVZF
                  IMpc7mf9Q+XfpZZ0Sp/x583y43ODrKTlcKcrCq7v8B/9zcEmt6TpcZ80Gclv57wR
                  ZTXhAoGBAKJDml9bEVzHyy2fKTiWhTLlePNTW0JveDxiXBbkh4UFAp3DOUJ/0Z59
                  YCibphcQXpE8npHhUHG2rcc4JojcA1k1I3QFkUz+9srnGXXvi7xmcpKF3mLX5RYc
                  lTMri8UCANBIbEgUACMxOce7IPEHwVelC7qWsOwLNF7+oWLGoxgv
                  -----END PRIVATE KEY-----

                x5c: |
                  -----BEGIN CERTIFICATE-----
                  MIIDyjCCArKgAwIBAgIIXi6TJOXIjucwDQYJKoZIhvcNAQELBQAwPDE6MDgGA1UE
                  AwwxVEVTVCBpU0hBUkUgRVUgSXNzdWluZyBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0
                  eSBHNTAeFw0yMjA3MTIxMzQ2MTJaFw0yNTA3MTExMzQ2MTFaMFYxFjAUBgNVBAMM
                  DUxvZ2lzbGlua3Rlc3QxHjAcBgNVBAUTFUVVLkVPUkkuTG9naXNsaW5rdGVzdDEP
                  MA0GA1UECgwGQ29sbE1pMQswCQYDVQQGEwJQVDCCASIwDQYJKoZIhvcNAQEBBQAD
                  ggEPADCCAQoCggEBAK4lALVG97U3fV790t5cabJZvxRrGjDOKTtfLpjjnIpcygWn
                  wTAStT2sB3I3e/U7bWUtHvYvu7+/hnecT3zBJbyArf6Pg6aBWeGZviqJa1lYUWYH
                  7qfGTY5lo7IqccrtXG9MifEwwx1CkK3QfYST2fCBPWNxcBjE+5Gc/3RjYV/s6dky
                  8tUyl0GZwf0Fn76kMIsjS9HGJ+149tPYu8FQ5Z2gT+d2IrKEjA/3C+hMjCqd7QUr
                  Ysja/k0uVBXkTLFLb8Qrr+PSRsORTVnsUiKUaWCRSdP5CgL9czvHA/7zsbHE49yn
                  D67DpOLsTbj8+Rgp7isUWbVQ1C8muOeKZ99m7m8CAwEAAaOBtTCBsjAfBgNVHSME
                  GDAWgBRtxWWJy9+RVNFrPLcCpS7NimiQHTAnBgNVHSUEIDAeBggrBgEFBQcDAgYI
                  KwYBBQUHAwQGCCsGAQUFBwMBMDcGCCsGAQUFBwEDBCswKTAIBgYEAI5GAQEwCAYG
                  BACORgEEMBMGBgQAjkYBBjAJBgcEAI5GAQYCMB0GA1UdDgQWBBQSwOKptoMKdwJr
                  WU79W7JkRmdxyTAOBgNVHQ8BAf8EBAMCBsAwDQYJKoZIhvcNAQELBQADggEBAC+i
                  nknVWB2J8vAFMf5Spaw9pMhzeSc3PicR7d0kqAaTPNu5VC4hkGCFBtAIzHR9GGpg
                  l/QKf06Vk7C1WY09Dtd/+mv9kvclVgpViM/edtd5A6Q1bOaENcwgDECgL7JPY7Es
                  buFrIBAa+tKowauQm19GoWT3M9tvBg0Q/oNYmnWlEBRvFJu4jsR9YCRRK4UVARR2
                  VRfLiveCWUSeV++Zoh5aCccZ2nq8PETozHAH9LdCDj01+Dq2Cq7MP09NvuPmLA+4
                  YuqBL/GDmiQN3RB/mokfz++AisFczKK3nktu+AKUw8puB1bdbsVaXGY+vs/GDHaw
                  woftQ5hxpL+48A1tQ9w=
                  -----END CERTIFICATE-----
                  -----BEGIN CERTIFICATE-----
                  MIIFcTCCA1mgAwIBAgIISFRJwGAAyjUwDQYJKoZIhvcNAQELBQAwRDEVMBMGA1UE
                  AwwMaVNIQVJFVGVzdENBMQ0wCwYDVQQLDARUZXN0MQ8wDQYDVQQKDAZpU0hBUkUx
                  CzAJBgNVBAYTAk5MMB4XDTE4MDcyMzE1MTQxM1oXDTIzMDcyMjE1MTQxM1owSDEZ
                  MBcGA1UEAwwQaVNIQVJFVGVzdENBX1RMUzENMAsGA1UECwwEVGVzdDEPMA0GA1UE
                  CgwGaVNIQVJFMQswCQYDVQQGEwJOTDCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCC
                  AgoCggIBAPueRXUGSUgu7qpAWJjAVH9z319XnuFleVeO/XxbJ6U4ixXRKvW8vKTV
                  1dRcfQeCqXk7ua/ZsqNrq89Ex95b0nqGUv1NoK2T8yEAkQzyzYZpW4c2YMCcg5am
                  RwCfYahHtJmXJWqREevM5kJoOacKH/GUbsemT94B0KXSNQ6IWcJyjpuaoDpb6Wd9
                  7T2luP1IQ5gkfwU38CZJKVkbY3eJkLlOwwtFsFPP2M4f8u479OkMUr5/m+xn73Ja
                  ZSJFOHvIN6DFpAls2ax7BhUSlbKM3YEuNb0O4oO5ynDFHvmllp6Nu0F2Xo0Bu0P/
                  uqb/08XvVWne7wcwWZR9+d78q+OlfC/m+wAwAqmQHEr8hJNvR6S/84HAjUdMyGcY
                  Tvov0tb0Zw/AKwDg8PC9UFRYb0cBr0+/GfgmJP5QMAfLqkXmZwYQSZ1FamNlJlmx
                  0sYZQSaudG0+Xkc991+Zw/x8uWZi9qQZeBOdwnI2xf/HJXHJsaZfDvTp5i8iVP75
                  1rhinwLi2dZnmSsQ96gvtTQBo4J5AvF+s9Il+TukeLtlKABaoMwz8wYBCnfKvUtk
                  p7JU5ijjYFaqQsFR3RpOHXcH/spZTYHuSs1OpHVbr0/cFtWZpv4tSQklPqCjddSA
                  SH9k3OBAhxenyXLkn9U9AAI34pZbFV+mksGGrN7ukk4obStI7z/5AgMBAAGjYzBh
                  MA8GA1UdEwEB/wQFMAMBAf8wHwYDVR0jBBgwFoAUra3KsTnUVnY8KXgl0RiiQBto
                  KEwwHQYDVR0OBBYEFBY85yDp1pTvH+Wi8bj8vurfLDeBMA4GA1UdDwEB/wQEAwIB
                  hjANBgkqhkiG9w0BAQsFAAOCAgEAeIJw1nnoOrsamueW4cZPLzrnuHSEvv1SEL1b
                  fB6F73anmxbq9+OYW6qojhxvorHTFzoQynsPmbso7t4b3HAtWaOlp3DKZUTpzOlL
                  nQ9gsDDfDVSJsJ5jxglDFZm0A07Ld3CxZhnzWf9A0QgNqN5hCcOsrl4uDMvZz+M9
                  kL/iksCx4X0so2OSm1QakraAR3umPc2ooAacPsAVCllekXFJ9DFjJ5Uv+rg8ZKHH
                  LGrP19o/AsXJYpKP/ttk5tBuA4JB20aShbcC539rA+Qc+kDHyRnL0aJyRYeBgY1i
                  AtuzXzMOk53XV+aJogDp3gF73s1c1YyIRHt7ofQG/0Zlwc/41CxOD+lyzG34RkgI
                  UO6UfjiGCFPmZQ2HkpKyqLifraRdqrHXOhoVd7HidYIihnZKDkLi1cfeo2mz8tWi
                  UzA+dPchaIElpQJPTjSbLjF2I19QyB8fuPazPfNIjHrXaKlaS3luKcFiqOYgcwWf
                  dZmDzxIU6PY2bzx/SDMoU24rAVSuGAYBIAlwf2pxmtLcbMA6bYr4trmQfbJrM8f8
                  JZgGQoItrpzrKjBJ2gFRt+065NMTNkB5rw8Xr56j5djkqB0/qHIcF2TiY/k/81Rm
                  TCYxrVHzM1czhXHXYzvnd2Jl1wJXyacWl7FiPaggw0YQidWHGMdItEuD/8SXiCXl
                  1OIvvic=
                  -----END CERTIFICATE-----
                  -----BEGIN CERTIFICATE-----
                  MIIFbTCCA1WgAwIBAgIIHjjfTuSjFjMwDQYJKoZIhvcNAQELBQAwRDEVMBMGA1UE
                  AwwMaVNIQVJFVGVzdENBMQ0wCwYDVQQLDARUZXN0MQ8wDQYDVQQKDAZpU0hBUkUx
                  CzAJBgNVBAYTAk5MMB4XDTE4MDcyMzE1MDUxM1oXDTI4MDcyMDE1MDUxM1owRDEV
                  MBMGA1UEAwwMaVNIQVJFVGVzdENBMQ0wCwYDVQQLDARUZXN0MQ8wDQYDVQQKDAZp
                  U0hBUkUxCzAJBgNVBAYTAk5MMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKC
                  AgEA4HIQ2eGXSP0bqgOs6IbrxTw/0u6XyRi5H/Z+j8hPzFeS/n7UcDs+48GYSgEN
                  1cIDBAGWjnwNM6u4RpQiG8xl7YtjWymwKm4HXtLAQqt72arY37PSF30Xi6VPBant
                  PTdaa+9zCU8CyFnEZ2fKTk1Sug36g6F6OjdgCCGkjdppKVyNIl5OW+kjFq2A9Gvt
                  BRGEwR2etotKtsIHI/g4cXOFZjtCCtPoEmjQ66fSwa7AjolpBb2PcssCVpb5c6sA
                  fp20JNn84kDQEoHjeoyNAqctBEIsRZF4kpTn4YhSXq0TH/kRtEEfNEmzLEOSaDWP
                  yL8qJJpx1aPAye0fkGfJi51cGRrFxf7jfN99Tjdf3yxwtT/yQquWLp6VLdqjJLk9
                  btGk+BiS9iVtw41Ec2ysX/3g0xeVVFGtyCwACWpyIx+Qm80KjVXkYDxhGiLQjQIz
                  VolPEVUDAZnw+LCmg3OY9Iy0PXTV0x3CKHM+C3ukZWkS1d3CSgDVl1+cpHJT4m6f
                  KnncO77yVO0yrW5218UGaYALOh8PHow36e9cB2c0bT2d1CHRekSl4+Bx+xQMGwsP
                  yveGgpkHidZtYRDP4E/HxNKy+wfByQeSu4YcUc8EHxy9qzxae28QfZn7s47V/PjA
                  k0dLZyQDonE9Q10OkMV15Dp9PWGeCQJri5JdOnr+iD8DdHsCAwEAAaNjMGEwDwYD
                  VR0TAQH/BAUwAwEB/zAfBgNVHSMEGDAWgBStrcqxOdRWdjwpeCXRGKJAG2goTDAd
                  BgNVHQ4EFgQUra3KsTnUVnY8KXgl0RiiQBtoKEwwDgYDVR0PAQH/BAQDAgGGMA0G
                  CSqGSIb3DQEBCwUAA4ICAQBCGYNl/1HFWVhDoPmkpVqm30ryqf6dWx1rxTW1lk9a
                  VUOlR9IRHPp1z/F/4fb6mIXFjFYw5lU2faHV9op4rNuGqRRSLiQPVvOXxDlxqA6D
                  mqziREvttG0uLZ/FOycKY53pWFCzG2keq6OId9JSpFmQDOiF7WSuifPLuwADkUw+
                  oZYGgWmbwQO0lXtw7XOny37nLZkYl89bRhIg/7fb+Xnb8914SMv0kGlk1kCeyL6F
                  XdXRTaat5c9XlJr9yzOUIDn54bY1BKT6YtiyJfvCNav/Fb24v5eq2Z9mBdZ70Cc9
                  5gPjqqxMZUgJo57YvhLfXDwxbWZWYC+WcR8nHkY+tZBlIih2CXHsOar5oH6drMdt
                  MIZz3UZJ/CxFG1u23Uz1jBfm/EggdKhOVnT6edruVoteWWCDB9Hdhxz8RAVYn5dq
                  UjkjRq4W9QAfJusrPZGBndT7yNaY/FHYKIq+uTarWibjdxtdYClaTwOxk5IqKNF9
                  eCKbPmxs1mlZrSLjMQFY3U9RkvzI+3IlAFkctUeabpkmXxnuWWSV2FJO9ZrONMWu
                  tw+567PK5gzM0FqQvb7sCxZuQDl5Ct6ZWlts2Y72t6pPjRI17+S8++a2vQdxBcNQ
                  0xF2tjvzTviZ3C5EqIeazWdgIZkqfWZkS8v+0MAvNZY+bbx+vSwLOoHQWrf/OCL7
                  AQ==
                  -----END CERTIFICATE-----
                  
          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization

      # keycloak example
      - host: "fiware-orion-ld"
        name: "orion-keycloak"
        port: 1026
        protocol: http

        routes:
          - name: orion-keycloak
            paths:
              - /keycloak
            strip_path: true

        plugins:
          - name: prometheus

          - name: rate-limiting
            config: 
              minute: 30

          - name: pep-plugin
            config:
              authorizationendpointtype: Keycloak
              authorizationendpointaddress: http://fiware-keycloak:80
              keycloakrealm: fiware-server
              keycloakclientid: orion-pep
              keycloakclientsecret: 978ad148-d99b-406d-83fc-578597290a79

          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization

      - host: "orion-ld"
        name: "orion-vc"
        port: 1026
        protocol: http
    
        routes:
          - name: orion-vc
            paths:
              - /orion-vc
            strip_path: true
    
        plugins:
          - name: pep-plugin
            config:
              pathprefix: "/orion-vc"
              authorizationendpointtype: ExtAuthz
              authorizationendpointaddress: http://fiware-pdp-dsba-pdp:8080/authz
                
          - name: request-transformer
            config:
              remove:
                headers:
                  - Authorization
                  - authorization


      - host: "fiware-pdp-dsba-pdp"    
        name: "trusted-list"
        port: 8080
        protocol: http

        routes: 
          - name: trusted-list
            paths: 
              - /issuer
